<html>
<head>
    <title>Texture Author</title>
    <meta charset="UTF-8">
    <script type="text/javascript" src="../substance/substance.js"></script>
    <script type="text/javascript" src="../texture.js"></script>
    <!--<script type="text/javascript" src="./data.js"></script>-->
    <!--import MarkupApp from "../lib/dmc/MarkupApp";-->
    <!--<script type="text/javascript" src="../lib/dmc/MarkupApp.js"></script>-->
    <style>
        /* Texture Component styles */
        @import '../texture.css';
        /* You may want to use your own reset and pagestyle */
        /*    @import '../substance/substance-reset.css';*/
        @import '../texture-reset.css';
        @import '../texture-pagestyle.css';
        /* Using url here, so font-awesome does not get bundled. */
        @import url('../font-awesome/css/font-awesome.min.css');

        body {
            overflow: hidden;
        }

        .sc-author {
            position: absolute;
            left: 0px;
            right: 0px;
            bottom: 0px;
            top: 100px;
        }

        /*.holds-the-iframe {*/
            /*background:url(../../../../client/images/spinner.gif) top no-repeat;*/
        /*}*/
        /*.holds-the-iframe:after{*/
            /*content: "Loading Publication . . . ";*/
        /*}*/
    </style>
    <script>
        let url_string = window.location.href;
        let url = new URL(url_string);
        let xmlId = url.searchParams.get('id');
        if(!xmlId){
            alert('No "id" parameter given')
        }
        if(xmlId.endsWith('.xml')){
            xmlId = xmlId.substr(0,xmlId.length-4);
        }
        let markupApp ;
//        alert('xmlId: '+xmlId);


        let texture = window.texture;

        /* Author Configuration */
        let configurator = new texture.TextureConfigurator()
            .import(texture.AuthorPackage)
            .setXMLStore(texture.ServerXMLStore);

        if (typeof window !== 'undefined') {
            window.onload = function () {
                let element = document.getElementById('message');
                element.innerHTML = "Loading Publication: "+xmlId;
                window.app = texture.Texture.mount({
                    configurator: configurator,
//                    documentId: '186262'
                    documentId: xmlId
                }, document.body);

//                element.innerHTML = "Publication Loaded ("+xmlId+")... Evaluating Links";
//
                this.markupApp = new texture.MarkupApp();
//                markupApp.getWords(function(data){
////                    alert('should be rendering the callback: '+JSON.stringify(data));
//                    markupApp.render(data,function (d2) {
//                        // render message is populatinged from withing here
//                    });
//                });
            }
        }
        function receiveMessage(event)
        {
//            alert(JSON.stringify(event));

            if(!event.isTrusted){
                alert('not trusted');
                return ;
            }
            let eventData = event.data;
            let action = eventData.action ;
            let publication = eventData.publication;
            let terms = eventData.terms;
            console.log("Action: " + action);
            console.log("Publication");
            console.log(publication);
            console.log("Terms");
            console.log(terms);
            if(terms){
                console.log(terms.length);
            }
            for(t in terms){
                console.log(terms[t].value);
            }

            if(action=="linkPub"){
                this.markupApp.searchWords(terms);
        	} else if(action=="navigate") {
				console.log(this.texture);
	        	//this.texture.send('tocEntrySelected', terms.path);
			}

            // Do we trust the sender of this message?  (might be
            // different from what we originally opened, for example).
            // if (event.origin !== "http://example.com")
            //     return;

            // event.source is popup
            // event.data is "hi there yourself!  the secret response is: rheeeeet!"
        }
        window.addEventListener("message", receiveMessage, false);

    </script>
</head>
<body>
	<div id="message">No Publication Selected</div>
</body>
</html>
