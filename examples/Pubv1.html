<html>
<head>
    <title>Texture Author</title>
    <meta charset="UTF-8">
    <script type="text/javascript" src="../substance/substance.js"></script>
    <script type="text/javascript" src="../texture.js"></script>
    <!--<script type="text/javascript" src="./data.js"></script>-->
    <!--import MarkupApp from "../lib/dmc/MarkupApp";-->
    <!--<script type="text/javascript" src="../lib/dmc/MarkupApp.js"></script>-->
    <style>
        /* Texture Component styles */
        @import '../texture.css';
        /* You may want to use your own reset and pagestyle */
        /*    @import '../substance/substance-reset.css';*/
        @import '../texture-reset.css';
        @import '../texture-pagestyle.css';
        /* Using url here, so font-awesome does not get bundled. */
        @import url('../font-awesome/css/font-awesome.min.css');

        body {
            overflow: hidden;
        }

        .sc-author {
            position: absolute;
            left: 0px;
            right: 0px;
            bottom: 0px;
            top: 0px;
        }

        /*.holds-the-iframe {*/
            /*background:url(../../../../client/images/spinner.gif) top no-repeat;*/
        /*}*/
        /*.holds-the-iframe:after{*/
            /*content: "Loading Publication . . . ";*/
        /*}*/
    </style>
    <script>
        let url_string = window.location.href;
        let url = new URL(url_string);
        let xmlId = url.searchParams.get('id');
        if(!xmlId){
            alert('No "id" parameter given')
        }
        if(xmlId.endsWith('.xml')){
            xmlId = xmlId.substr(0,xmlId.length-4);
        }
        let markupApp ;
//        alert('xmlId: '+xmlId);


        let texture = window.texture;

        /* Author Configuration */
        let configurator = new texture.TextureConfigurator()
            .import(texture.AuthorPackage)
            .setXMLStore(texture.ServerXMLStore);

        if (typeof window !== 'undefined') {
            window.onload = function () {
                let element = document.getElementById('message');
                element.innerHTML = "Loading Publication: "+xmlId;
                window.app = texture.Texture.mount({
                    configurator: configurator,
//                    documentId: '186262'
                    documentId: xmlId
                }, document.body);

//                element.innerHTML = "Publication Loaded ("+xmlId+")... Evaluating Links";
//
                this.markupApp = new texture.MarkupApp();
//                markupApp.getWords(function(data){
////                    alert('should be rendering the callback: '+JSON.stringify(data));
//                    markupApp.render(data,function (d2) {
//                        // render message is populatinged from withing here
//                    });
//                });
				
            }
		}
        function receiveMessage(event)
        {
//            alert(JSON.stringify(event));

            if(!event.isTrusted){
                alert('not trusted');
                return ;
            }
            let eventData = event.data;
            let action = eventData.action ;
            let publication = eventData.publication;
            let terms = eventData.terms;
            console.log("Action: " + action);
            console.log("Terms: " + terms);

            if(action=="linkPub"){
                this.markupApp.searchWords(terms);
        	} else if(action=="navigate") {
				window.app.childNodes[0].send('tocEntrySelected', terms.path);
			} else if(action == "setHighlights") {
				let hl = {}
				hl['ext-links'] = []
				for (let p in terms) {
					hl['ext-links'].push(terms[p])
				}
				if(hl['ext-links'].length > 0) {
					console.log("timeout to allow pub to load")
					setTimeout(function() {
						window.app.childNodes[0].contentHighlights.set(hl)
					}, 1000)
				}
			} else if(action == "deleteExtLink") {
				let nodeId = terms.extLinkId
				window.app.state.documentSession.transaction(function(tx, args) {
					tx.delete(nodeId)
				})

				window.app.state.documentSession.save()
			} else if(action == "updateLink") {
				window.app.state.documentSession.transaction(function(tx, args) {
					tx.set([terms.extLinkId, 'hrefLink'], terms.link)
				})
				window.app.state.documentSession.save()
			} else if(action == "applyRules") {
				this.markupApp.applyRules(eventData.ruleSet)
			
			}

            // Do we trust the sender of this message?  (might be
            // different from what we originally opened, for example).
            // if (event.origin !== "http://example.com")
            //     return;

            // event.source is popup
            // event.data is "hi there yourself!  the secret response is: rheeeeet!"
        }
        window.addEventListener("message", receiveMessage, false);
			 window.parent.postMessage({
        		    action: 'setHighlights'
        			}, "*");

    </script>
</head>
<body>
	<div id="message" style="display: none;">No Publication Selected</div>
</body>
</html>
